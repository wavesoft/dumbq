/*! DumbQ API v1.0 | Ioannis Charalampidis, Citizen Cyberlab EU Project | GNU GPL v2.0 License */
(window.define==undefined?function(b,a){window.DumbQ=a($||jQuery)}:window.define)(["jquery"],function(b){if(!b){console.error("CreditPiggy: jQuery must available in order to use creditpiggy.js!");return null}var c={};var a=c.Frontend=function(){this.baseUrl=null;this.pollTimer=null;this.pollActive=false;this.disabled=true;this.offline=true;this.seq_id=0;this.seq_uuid="";this.machine={};this.index={};this.instances=[];var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234567890";for(var d=0;d<32;d++){this.seq_uuid+=e[parseInt(Math.random()*e.length)]}this.seq_uuid+="-";this.errorCounter=0};a.prototype.__same=function(e,d){if((e==undefined)&&(d==undefined)){return true}if((e==undefined)||(d==undefined)){return false}for(var f in e){if(e.hasOwnProperty(f)){if(d.hasOwnProperty(f)){if(typeof(e[f])!=typeof(d[f])){return false}if(typeof(e[f])=="object"){if(!this.__same(e[f],d[f])){return false}}if(e[f]!=d[f]){return false}}else{return false}}}for(var f in d){if(d.hasOwnProperty(f)&&!e.hasOwnProperty(f)){return false}}return true};a.prototype.__markOfflineInstance=function(d){if(d.offline){return}d.offline=true;b(this).triggerHandler("offline_instance",[d])};a.prototype.__updateSummarization=function(){var f=0,e=0;for(var g=0;g<this.instances.length;g++){var d=this.instances[g];if(d.offline){continue}if(d.metrics!==undefined){f+=parseFloat(d.metrics["progress"]||0);e+=1}}var h={};h.progress=(f/e)||0;h.load=(this.index.load||[])[1]||0;h.uptime=(this.index.uptime||[])[0]||0;h.idletime=(this.index.uptime||[])[1]||0;h.runhours=this.index.runhours||0;var j=(this.index.load||[])[1]||0;if(j>1){if(j>2){j=2}j=0.8+(j-1)*0.2}else{j*=0.8}h.activity=j;console.log("summarisation:",h);b(this).triggerHandler("metrics_details",[h])};a.prototype.__updateInstance=function(d,e){if(d.offline){d.metrics=e;d.offline=false;b(this).triggerHandler("online_instance",[d,e]);b(this).triggerHandler("metrics_instance",[e,d]);return}if(!this.__same(d.metrics,e)){d.metrics=e;b(this).triggerHandler("metrics_instance",[e,d])}};a.prototype.__updateIndex=function(e){this.index=e;var l=e.instances||[];for(var g=0;g<l.length;g++){var h=l[g],k=false;for(var d=0;d<this.instances.length;d++){var f=this.instances[d];if(h.uuid==f.uuid){k=true;break}}if(!k){h.offline=true;h.metrics={};this.instances.push(h);b(this).triggerHandler("created.instance",[h])}}for(var g=0;g<this.instances.length;g++){var h=this.instances[g],k=false;for(var d=0;d<l.length;d++){var f=l[d];if(h.uuid==f.uuid){k=true;break}}if(!k){b(this).triggerHandler("destroyed.instance",[h]);this.instances.splice(g,1);g-=1}}};a.prototype.__updateMachine=function(d){this.machine=d;if(this.offline){this.offline=false;b(this).triggerHandler("online",[this.machine])}};a.prototype.__markOffline=function(){if(this.offline){return}for(var d=0;d<this.instances.length;d++){this.__markOfflineInstance(this.instances[d])}this.instances=[];this.index={};this.machine={};this.offline=true;b(this).triggerHandler("offline")};a.prototype.__poll=function(){if(this.pollActive||this.disabled){return}var e=(function(){if(this.disabled){return}this.pollActive=false;this.pollTimer=setTimeout(this.__poll.bind(this),5000);this.__updateSummarization()}).bind(this);var g=(function(i,j){b.ajax({url:this.baseUrl+i.wwwroot+"/metrics.json",method:"GET",dataType:"json",data:{s:this.seq_uuid+(this.seq_id++)}}).done((function(k){if(this.disabled){return}this.__updateInstance(i,k)}).bind(this)).fail((function(){if(this.disabled){return}this.__markOfflineInstance(i)}).bind(this)).always((function(){j()}).bind(this))}).bind(this);var f=(function(){var l=[e];for(var j=0;j<this.instances.length;j++){l.unshift((function(i){return function(m){g(i,m)}})(this.instances[j]))}var k=function(){if(this.disabled){return}if(l.length==1){var i=l.shift();i()}else{var i=l.shift();i(k)}};k()}).bind(this);var d=(function(){b.ajax({url:this.baseUrl+"/index.json",method:"GET",dataType:"json",data:{s:this.seq_uuid+(this.seq_id++)}}).done((function(i){if(this.disabled){return}this.errorCounter=0;this.__updateIndex(i);f()}).bind(this)).fail((function(){if(this.disabled){return}if(++this.errorCounter>1){this.__markOffline()}e()}).bind(this))}).bind(this);var h=(function(){b.ajax({url:this.baseUrl+"/machine.json",method:"GET",dataType:"json",data:{s:this.seq_uuid+(this.seq_id++)}}).done((function(i){if(this.disabled){return}this.__updateMachine(i);d()}).bind(this)).fail((function(){if(this.disabled){return}this.__markOffline();e()}).bind(this))}).bind(this);this.pollActive=true;if(this.offline){h()}else{d()}};a.prototype.enable=function(d){if(!this.disabled){return}this.baseUrl=d;this.disabled=false;this.pollActive=false;this.__poll()};a.prototype.disable=function(){if(this.disabled){return}this.__markOffline();this.disabled=true;this.offline=true;this.machine={};this.index={};this.instances=[];this.errorCounter=0};return c});